## Overview

This code creates a resilient infrastructure for a given Single Availability Zone, i.e., SAZ. VSIs are placed in instance groups (also known as auto-scale) to provide an automated way to add or remove VSIs based on load conditions.
Placement groups ensure that the VSIs are created on different host:

- Web and app use host spread.
- db uses power spread. Power spread guarantees each instance is placed on host with separate power and network supplies.

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Required Inputs

| Name                                                                                       | Description                                                                                                                                                                                                                                                                                          | Type     | Default | Required |
| ------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | ------- | :------: |
| <a name="input_api_key"></a> [api_key](#input_api_key)                                     | This is the API key for the IBM Cloud account used to create the resources. [Learn more](https://cloud.ibm.com/docs/account?topic=account-userapikey&interface=ui)                                                                                                                                   | `string` | n/a     |   yes    |
| <a name="input_resource_group_name"></a> [resource_group_name](#input_resource_group_name) | Resource group name from your IBM Cloud account where the VPC resources will be deployed.                                                                                                                                                                                                            | `string` | n/a     |   yes    |
| <a name="input_zone"></a> [zone](#input_zone)                                              | Enter the zone where the VPC resources will be deployed. [Learn more](https://cloud.ibm.com/docs/overview?topic=overview-locations#table-mzr)                                                                                                                                                        | `string` | n/a     |   yes    |
| <a name="input_user_ssh_keys"></a> [user_ssh_keys](#input_user_ssh_keys)                   | Comma-separated list of names of SSH key configured in your IBM Cloud account that is used to establish a connection to the bastion server. Ensure the SSH key is present in the same region where the 3-tier app is being deployed. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-ssh-keys) | `string` | n/a     |   yes    |
| <a name="input_public_ip_addresses"></a> [public_ip_addresses](#input_public_ip_addresses) | Comma-separated allowed list of host IP addresses to access the bastion server.                                                                                                                                                                                                                      | `string` | n/a     |   yes    |
| <a name="input_prefix"></a> [prefix](#input_prefix)                                        | An alphanumeric prefix identifier that will be added to the beginning of all of the VPC resources. It should end with a hyphen (-) and does not exceed 11 characters.                                                                                                                                 | `string` | n/a     |   yes    |
| <a name="input_bastion_image"></a> [bastion_image](#input_bastion_image)                   | Image type you want to use for the bastion server. This can be either a custom image or IBM Cloud stock image. Image ID is 41 characters and region-specific. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-about-images&interface=ui)                                                       | `string` | n/a     |   yes    |
| <a name="input_web_image"></a> [web_image](#input_web_image)                               | Image type you want to use for the web server. This can be either a custom image or IBM Cloud stock image. Image ID is 41 characters and region-specific. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-about-images&interface=ui)                                                           | `string` | n/a     |   yes    |
| <a name="input_app_image"></a> [app_image](#input_app_image)                               | Image type you want to use for the app server. This can be either a custom image or IBM Cloud stock image. Image ID is 41 characters and region-specific. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-about-images&interface=ui)                                                           | `string` | n/a     |   yes    |
| <a name="input_db_image"></a> [db_image](#input_db_image)                                  | Image type you want to use for the db server. This can be either a custom image or IBM Cloud stock image. Image ID is 41 characters and region-specific. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-about-images&interface=ui)                                                            | `string` | n/a     |   yes    |

## Optional Inputs

| Name                                                                                                      | Description                                                                                                                                                                                                                                                                                                             | Type     | Default             | Required |
| --------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | ------------------- | :------: |
| <a name="input_web_lb_type"></a> [web_lb_type](#input_web_lb_type)                                        | Determine if a public or private 3-tier application. Valid values are public or private.                                                                                                                                                                                                                                | `string` | `"public"`          |    no    |
| <a name="input_bastion_ip_count"></a> [bastion_ip_count](#input_bastion_ip_count)                         | Total host IPs for the bastion subnet. Valid values 8, 16, 32, 64.                                                                                                                                                                                                                                                      | `number` | `8`                 |    no    |
| <a name="input_bastion_ssh_key_var_name"></a> [bastion_ssh_key_var_name](#input_bastion_ssh_key_var_name) | IBM Cloud object name for bastion server SSH key.                                                                                                                                                                                                                                                                        | `string` | `"bastion-ssh-key"` |    no    |
| <a name="input_bastion_profile"></a> [bastion_profile](#input_bastion_profile)                            | VSI profile size which determines size of vCPU, RAM and network bandwidth for the bastion server. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-profiles&interface=ui)                                                                                                                                          | `string` | `"cx2-2x4"`         |    no    |
| <a name="input_web_instance_profile"></a> [web_instance_profile](#input_web_instance_profile)             | VSI profile size which determines size of vCPU, RAM and network bandwidth for the web servers. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-profiles&interface=ui)                                                                                                                                             | `string` | `"cx2-2x4"`         |    no    |
| <a name="input_web_aggregation_window"></a> [web_aggregation_window](#input_web_aggregation_window)       | The aggregation window is the time period in seconds that the instance group manager monitors each instance and determines the average utilization for the web servers group. Value should be between 90 to 600. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-auto-scale-instance-group&interface=ui) | `number` | `90`                |    no    |
| <a name="input_web_cooldown_time"></a> [web_cooldown_time](#input_web_cooldown_time)                      | The cooldown period is the time in seconds to pause further scaling actions after scaling takes place for the web servers. Value should be between 120 and 3600. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-auto-scale-instance-group&interface=ui)                                                 | `number` | `120`               |    no    |
| <a name="input_web_cpu_threshold"></a> [web_cpu_threshold](#input_web_cpu_threshold)                      | The average utilization the web server instance group should achieve. This value defines when to add or remove web server instances to the group. Value should be between 10 and 90. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-auto-scale-instance-group&interface=ui)                             | `number` | `75`                |    no    |
| <a name="input_web_min_servers_count"></a> [web_min_servers_count](#input_web_min_servers_count)          | Minimum web server count that the instance group cannot go below. Allowed value is between 1 and 1000. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-profiles&interface=ui)                                                                                                                                     | `number` | `3`                 |    no    |
| <a name="input_web_max_servers_count"></a> [web_max_servers_count](#input_web_max_servers_count)          | Maximum web server count that the instance group can scale up to. Allowed value is between 1 and 1000. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-profiles&interface=ui)                                                                                                                                     | `number` | `6`                 |    no    |
| <a name="input_web_pg_strategy"></a> [web_pg_strategy](#input_web_pg_strategy)                            | The strategy for Web servers placement group - host_spread: place on different compute hosts - power_spread: place on compute hosts that use different power sources.                                                                                                                                                   | `string` | `"host_spread"`     |    no    |
| <a name="input_app_instance_profile"></a> [app_instance_profile](#input_app_instance_profile)             | VSI profile size which determines size of vCPU, RAM and network bandwidth for the app servers. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-profiles&interface=ui)                                                                                                                                            | `string` | `"cx2-2x4"`         |    no    |
| <a name="input_app_aggregation_window"></a> [app_aggregation_window](#input_app_aggregation_window)       | The aggregation window is the time period in seconds that the instance group manager monitors each instance and determines the average utilization for the app servers group. Value should be between 90 to 600. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-auto-scale-instance-group&interface=ui) | `number` | `90`                |    no    |
| <a name="input_app_cooldown_time"></a> [app_cooldown_time](#input_app_cooldown_time)                      | The cooldown period is the time in seconds to pause further scaling actions after scaling takes place for the app servers. Value should be between 120 and 3600. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-auto-scale-instance-group&interface=ui)                                                 | `number` | `120`               |    no    |
| <a name="input_app_cpu_threshold"></a> [app_cpu_threshold](#input_app_cpu_threshold)                      | The average utilization the app server instance group should achieve. This value defines when to add or remove app server instances to the group. Value should be between 10 and 90. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-auto-scale-instance-group&interface=ui)                             | `number` | `75`                |    no    |
| <a name="input_app_min_servers_count"></a> [app_min_servers_count](#input_app_min_servers_count)          | Minimum app server count that the instance group cannot go below. Allowed value is between 1 and 1000. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-profiles&interface=ui)                                                                                                                                     | `number` | `3`                 |    no    |
| <a name="input_app_max_servers_count"></a> [app_max_servers_count](#input_app_max_servers_count)          | Maximum app server count that the instance group can scale up to. Allowed value is between 1 and 1000. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-profiles&interface=ui)                                                                                                                                     | `number` | `6`                 |    no    |
| <a name="input_app_pg_strategy"></a> [app_pg_strategy](#input_app_pg_strategy)                            | The strategy for App servers placement group - host_spread: place on different compute hosts - power_spread: place on compute hosts that use different power sources.                                                                                                                                                   | `string` | `"host_spread"`     |    no    |
| <a name="input_db_profile"></a> [db_profile](#input_db_profile)                                           | VSI profile size which determines size of vCPU, RAM and network bandwidth for the db servers. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-profiles&interface=ui)                                                                                                                                              | `string` | `"cx2-2x4"`         |    no    |
| <a name="input_db_vsi_count"></a> [db_vsi_count](#input_db_vsi_count)                                     | Total number of db servers to be created in the VPC.                                                                                                                                                                                                                                                                    | `number` | `2`                 |    no    |
| <a name="input_data_vol_size"></a> [data_vol_size](#input_data_vol_size)                                  | Data volume storage size for the db server in GB. Value should be in between 10 and 2000.                                                                                                                                                                                                                               | `number` | `10`                |    no    |
| <a name="input_db_pg_strategy"></a> [db_pg_strategy](#input_db_pg_strategy)                               | The strategy for Database servers placement group - host_spread: place on different compute hosts - power_spread: place on compute hosts that use different power sources.                                                                                                                                              | `string` | `"power_spread"`    |    no    |
| <a name="input_iops_tier"></a> [iops_tier](#input_iops_tier)                                              | Enter the IOPs (IOPS per GB) tier for db data volume. Valid values are 3, 5, and 10. [Learn more](https://cloud.ibm.com/docs/vpc?topic=vpc-block-storage-profiles&interface=ui#tiers)                                                                                                                                   | `number` | `5`                 |    no    |
| <a name="input_enable_file_share"></a> [enable_file_share](#input_enable_file_share)                            | This creates File Share storage for the App Tier to support stateful use case. Select true or false.                                                                                                                                                                                                                    | `bool`   | `false`             |    no    |
| <a name="input_share_size"></a> [share_size](#input_share_size)                                           | File Share storage size in GB. Value should be in between 10 and 32000.                                                                                                                                                                                                                                                 | `number` | `500`               |    no    |
| <a name="input_share_profile"></a> [share_profile](#input_share_profile)                                  | Enter the IOPs (IOPS per GB) tier for File Share storage. Valid values are 3, 5, and 10.                                                                                                                                                                                                                                | `string` | `"tier-3iops"`      |    no    |
| <a name="input_replica_zone"></a> [replica_zone](#input_replica_zone)                                     | Enter the zone where the File Share Replica storage will be created e.g. us-south-1, us-east-1, etc.                                                                                                                                                                                                                    | `string` | `""`                |    no    |
| <a name="input_replication_cron_spec"></a> [replication_cron_spec](#input_replication_cron_spec)          | Enter the file share replication schedule in Linux crontab format.                                                                                                                                                                                                                                                      | `string` | `"00 08 * * *"`     |    no    |

<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
